<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Voice Quest ğŸŒŒ</title>
<style>
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: radial-gradient(circle at top left,#0f0c29,#302b63,#24243e); color:#e0e0e0; text-align:center; min-height:100vh; }
.container { max-width:800px; margin:2rem auto; background: rgba(30,30,50,0.8); padding:2rem; border-radius:15px; box-shadow:0 0 40px rgba(72,61,139,0.5);}
input, select { width:80%; padding:0.8rem; margin:0.5rem 0 1rem 0; border-radius:8px; border:1px solid #6c5fc7; background:rgba(255,255,255,0.1); color:#e0e0e0; font-size:1rem; }
label { display:block; margin-top:1rem; font-weight:bold; }
button { padding:1rem 2rem; margin:0.5rem; border:none; border-radius:10px; font-size:1rem; cursor:pointer; background-color:#4a3f9f; color:#fff; transition: background-color 0.3s ease, box-shadow 0.3s ease;}
button:hover:not(:disabled) { background-color:#6c5fc7; box-shadow:0 0 15px rgba(108,95,199,0.6);}
button:disabled { opacity:0.5; cursor:not-allowed; }
.correct { background-color: #00ff9f !important; color:#000; }
.wrong { background-color: #ff4f6e !important; color:#fff; }
#sentenceBox { margin:2rem 0; font-weight:bold; font-size:1.2rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:8px; line-height:1.6; }
.feedback { margin-top:1rem; font-size:1.1rem; padding:1rem; border-radius:8px; white-space: pre-wrap; }
audio { margin-top:1rem; width:100%; max-width:500px; }
#audioControls { margin-top:1rem; }
#audioControls a { display:inline-block; padding:0.8rem 1.5rem; background:#00ffff; color:#000; text-decoration:none; border-radius:8px; margin-top:1rem; font-weight:bold; }
#audioControls a:hover { background:#00cccc; }
#scoreCard { font-size:1.1rem; line-height:2; text-align:left; padding:1rem; }
#scoreCard p { margin:0.8rem 0; }
.error-message { color:#ff4f6e; margin-top:0.5rem; }
.tip { font-size:0.9rem; color:#aaa; margin:1rem 0; line-height:1.5; }
</style>
</head>
<body>

<div class="container" id="setupContainer">
  <h2>ğŸŒŒ Voice Quest</h2>
  <p>Select your details and start the speaking challenge!</p>
  
  <label>Name:</label>
  <input type="text" id="nameInput" placeholder="Enter your name"/>

  <label>Department:</label>
  <select id="departmentSelect">
    <option value="">-- Select Department --</option>
    <option value="Cyber Security">Cyber Security</option>
    <option value="Mechanical">Mechanical</option>
  </select>

  <label>Register Number:</label>
  <select id="regNoSelect">
    <option value="">-- Select Register Number --</option>
  </select>

  <div class="error-message" id="setupError"></div>
  <button onclick="beginQuest()">Start Quest</button>
</div>

<div class="container" id="questContainer" style="display:none;">
  <h2>ğŸ“– Read the Sentence Aloud</h2>
  <div id="sentenceBox"></div>
  <div class="tip">
    ğŸ’¡ <strong>Tips:</strong><br>
    â€¢ Click "Start Speaking" and speak immediately<br>
    â€¢ Speak clearly and at normal pace<br>
    â€¢ Wait 2-3 seconds after speaking before clicking Stop<br>
    â€¢ If "no speech detected", try speaking louder or closer to mic
  </div>
  <button id="startRec">ğŸ¤ Start Speaking</button>
  <button id="stopRec" disabled>â¹ Stop</button>
  <button id="viewScoreBtn" style="display:none; background:#00ff9f; color:#000;">â¡ï¸ View Score</button>
  <div class="feedback" id="feedback"></div>
  <div id="audioControls"></div>
</div>

<div class="container" id="scoreContainer" style="display:none;">
  <h2>ğŸ‰ Quest Completed!</h2>
  <div id="scoreCard"></div>
  <button id="restartBtn">ğŸ”„ Restart Quest</button>
</div>

<script>
// HARD-CODED DATA
const data = [
  {department:"Cyber Security", regNo:"CS101", sentence:"Grit gathers glory, grows greatness and makes grand the game of life"},
  {department:"Cyber Security", regNo:"CS102", sentence:"Be yourself everyone else is already taken"},
  {department:"Mechanical", regNo:"ME101", sentence:"Engineering minds build bridges and shape the world"},
  {department:"Mechanical", regNo:"ME102", sentence:"Innovation comes from persistence and curiosity"}
];

const departmentSelect = document.getElementById("departmentSelect");
const regNoSelect = document.getElementById("regNoSelect");
const sentenceBox = document.getElementById("sentenceBox");
const feedback = document.getElementById("feedback");
const audioControls = document.getElementById("audioControls");
const setupError = document.getElementById("setupError");
const viewScoreBtn = document.getElementById("viewScoreBtn");

let playerName="", playerDepartment="", playerRegNo="", currentSentence="";
let similarityScore=0;
let mediaRecorder;
let audioChunks = [];
let recognition;
let audioStream;
let spokenText = "";
let recognitionStarted = false;

// Check browser support
if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
  alert('âš ï¸ Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
}

// Populate register numbers based on department
departmentSelect.addEventListener('change', ()=>{
  const dept = departmentSelect.value;
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  if(dept) {
    data.filter(d=>d.department===dept).forEach(d=>{
      const option = document.createElement('option');
      option.value = d.regNo;
      option.textContent = d.regNo;
      regNoSelect.appendChild(option);
    });
  }
  setupError.textContent = "";
});

function beginQuest(){
  playerName = document.getElementById("nameInput").value.trim();
  playerDepartment = departmentSelect.value;
  playerRegNo = regNoSelect.value;
  
  if(!playerName || !playerDepartment || !playerRegNo){
    setupError.textContent = "âš ï¸ Please fill all fields!";
    return;
  }
  
  const entry = data.find(d=>d.department===playerDepartment && d.regNo===playerRegNo);
  if(!entry) {
    setupError.textContent = "âš ï¸ Invalid selection!";
    return;
  }
  
  currentSentence = entry.sentence;
  sentenceBox.textContent = currentSentence;
  
  document.getElementById("setupContainer").style.display = "none";
  document.getElementById("questContainer").style.display = "block";
  
  // Reset feedback and controls
  feedback.textContent = "";
  feedback.className = "feedback";
  audioControls.innerHTML = "";
  viewScoreBtn.style.display = "none";
}

// START RECORDING
document.getElementById("startRec").addEventListener("click", async ()=>{
  try {
    // Reset
    audioChunks = [];
    spokenText = "";
    recognitionStarted = false;
    audioControls.innerHTML = "";
    feedback.textContent = "ğŸ™ï¸ Listening... START SPEAKING NOW!";
    feedback.className = "feedback";
    viewScoreBtn.style.display = "none";
    
    // Request microphone access
    audioStream = await navigator.mediaDevices.getUserMedia({audio: true});
    
    // Start recording
    mediaRecorder = new MediaRecorder(audioStream);
    mediaRecorder.ondataavailable = e => { 
      if(e.data.size > 0) {
        audioChunks.push(e.data); 
      }
    };
    mediaRecorder.onstop = ()=> { 
      console.log("MediaRecorder stopped");
      createPlaybackAndDownload();
      // Stop all audio tracks
      if(audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }
    };
    
    mediaRecorder.start();
    console.log("MediaRecorder started");
    
    // Initialize speech recognition with better settings
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "en-US";
    recognition.interimResults = true; // Changed to true for better detection
    recognition.continuous = true; // Changed to true
    recognition.maxAlternatives = 1;
    
    recognition.onstart = () => {
      console.log("âœ… Speech recognition started successfully");
      recognitionStarted = true;
      feedback.textContent = "ğŸ™ï¸ Listening... I can hear you! Keep speaking...";
    };
    
    recognition.onresult = (event)=>{
      console.log("ğŸ“ Recognition result received");
      
      // Get the latest result
      const lastResult = event.results[event.results.length - 1];
      const transcript = lastResult[0].transcript.trim();
      
      if(lastResult.isFinal) {
        console.log("âœ… Final result:", transcript);
        spokenText = transcript;
        similarityScore = compareText(spokenText, currentSentence);
        console.log("ğŸ“Š Similarity score:", similarityScore);
        showFeedback();
      } else {
        // Show interim results
        console.log("â³ Interim result:", transcript);
        feedback.textContent = "ğŸ™ï¸ Hearing: \"" + transcript + "\"";
      }
    };
    
    recognition.onspeechstart = () => {
      console.log("ğŸ—£ï¸ Speech detected!");
      feedback.textContent = "ğŸ™ï¸ Great! I'm hearing you... keep going!";
    };
    
    recognition.onspeechend = () => {
      console.log("ğŸ”‡ Speech ended");
    };
    
    recognition.onerror = (event)=>{
      console.error("âŒ Recognition error:", event.error);
      let errorMsg = "";
      
      switch(event.error) {
        case 'no-speech':
          errorMsg = "âš ï¸ No speech detected.\n\nTips:\nâ€¢ Speak louder or closer to the microphone\nâ€¢ Check if your mic is working\nâ€¢ Try again and start speaking immediately";
          break;
        case 'audio-capture':
          errorMsg = "âš ï¸ No microphone found. Please check your device.";
          break;
        case 'not-allowed':
          errorMsg = "âš ï¸ Microphone permission denied. Please allow access and refresh.";
          break;
        case 'aborted':
          errorMsg = "âš ï¸ Recording was stopped.";
          break;
        case 'network':
          errorMsg = "âš ï¸ Network error. Check your internet connection.";
          break;
        default:
          errorMsg = "âš ï¸ Error: " + event.error;
      }
      
      feedback.textContent = errorMsg;
      feedback.className = "feedback";
      
      // Re-enable buttons
      document.getElementById("startRec").disabled = false;
      document.getElementById("stopRec").disabled = true;
      
      // Stop media recorder if active
      if(mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      if(audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }
    };
    
    recognition.onend = ()=>{
      console.log("ğŸ Recognition ended");
      
      // If we have text but haven't shown feedback yet
      if(spokenText && feedback.textContent.includes("Hearing:")) {
        similarityScore = compareText(spokenText, currentSentence);
        showFeedback();
      }
    };
    
    try {
      recognition.start();
      console.log("ğŸ¬ Recognition start initiated");
    } catch(e) {
      console.error("Error starting recognition:", e);
      feedback.textContent = "âš ï¸ Could not start speech recognition. Try refreshing the page.";
    }
    
    // Update button states
    document.getElementById("startRec").disabled = true;
    document.getElementById("stopRec").disabled = false;
    
  } catch(error) {
    console.error("âŒ Error starting recording:", error);
    feedback.textContent = "âš ï¸ Could not access microphone. Please grant permission and try again.";
    feedback.className = "feedback";
  }
});

// STOP RECORDING
document.getElementById("stopRec").addEventListener("click", ()=>{
  console.log("â¹ï¸ Stop button clicked");
  
  if(recognition) {
    try {
      recognition.stop();
      console.log("Recognition stop initiated");
    } catch(e) {
      console.error("Error stopping recognition:", e);
    }
  }
  
  if(mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    console.log("MediaRecorder stop initiated");
  }
  
  document.getElementById("startRec").disabled = false;
  document.getElementById("stopRec").disabled = true;
  
  // If no speech was captured
  if(!spokenText) {
    setTimeout(() => {
      if(!spokenText) {
        feedback.textContent = "âš ï¸ No speech was captured.\n\nPlease try again and:\nâ€¢ Start speaking immediately after clicking 'Start Speaking'\nâ€¢ Speak clearly and loud enough\nâ€¢ Make sure your microphone is working";
        feedback.className = "feedback";
      }
    }, 1000);
  }
});

// SHOW FEEDBACK AFTER RECOGNITION
function showFeedback() {
  if(similarityScore >= 0.7){
    feedback.textContent = `âœ… Great job! Accuracy: ${Math.round(similarityScore*100)}%\n\nYou said: "${spokenText}"`;
    feedback.className = "feedback correct";
  } else {
    feedback.textContent = `âŒ Not quite right. Accuracy: ${Math.round(similarityScore*100)}%\n\nYou said: "${spokenText}"\n\nExpected: "${currentSentence}"`;
    feedback.className = "feedback wrong";
  }
  
  // SHOW VIEW SCORE BUTTON
  viewScoreBtn.style.display = "inline-block";
  
  console.log("âœ… Feedback shown, View Score button displayed");
}

// VIEW SCORE BUTTON
viewScoreBtn.addEventListener("click", showScore);

// CREATE PLAYBACK AND DOWNLOAD
function createPlaybackAndDownload(){
  if(audioChunks.length === 0) {
    console.warn("No audio chunks recorded");
    return;
  }
  
  const blob = new Blob(audioChunks, {type:'audio/webm'});
  const url = URL.createObjectURL(blob);
  
  const audioEl = document.createElement('audio');
  audioEl.controls = true;
  audioEl.src = url;
  
  const downloadBtn = document.createElement('a');
  downloadBtn.href = url;
  downloadBtn.download = `${playerName}_${playerRegNo}_recording.webm`;
  downloadBtn.textContent = "â¬‡ï¸ Download Recording";
  
  audioControls.innerHTML = "";
  audioControls.appendChild(audioEl);
  audioControls.appendChild(downloadBtn);
  
  console.log("ğŸµ Audio playback created");
}

// SHOW SCORE
function showScore() {
  console.log("ğŸ“Š showScore called");
  
  const accuracyPercent = Math.round(similarityScore * 100);
  let grade = "";
  let emoji = "";
  
  if(accuracyPercent >= 90) {
    grade = "Excellent!";
    emoji = "ğŸ†";
  } else if(accuracyPercent >= 70) {
    grade = "Good Job!";
    emoji = "ğŸ‘";
  } else if(accuracyPercent >= 50) {
    grade = "Keep Practicing!";
    emoji = "ğŸ’ª";
  } else {
    grade = "Try Again!";
    emoji = "ğŸ¯";
  }
  
  document.getElementById("scoreCard").innerHTML = `
    <p>${emoji} <strong>Grade:</strong> ${grade}</p>
    <p>ğŸ“Š <strong>Accuracy:</strong> ${accuracyPercent}%</p>
    <p>ğŸ‘¤ <strong>Player:</strong> ${playerName}</p>
    <p>ğŸ· <strong>Department:</strong> ${playerDepartment}</p>
    <p>ğŸ”¢ <strong>Register No:</strong> ${playerRegNo}</p>
    <hr style="border:1px solid rgba(255,255,255,0.2); margin:1rem 0;">
    <p>ğŸ“ <strong>Expected:</strong><br>"${currentSentence}"</p>
    <p>ğŸ—£ï¸ <strong>You said:</strong><br>"${spokenText || 'Nothing captured'}"</p>
  `;
  
  document.getElementById("questContainer").style.display = "none";
  document.getElementById("scoreContainer").style.display = "block";
  
  console.log("âœ… Score container displayed");
}

// TEXT COMPARISON FUNCTIONS
function compareText(a, b){ 
  const longer = a.length > b.length ? a : b; 
  const shorter = a.length > b.length ? b : a; 
  if(longer.length === 0) return 1.0; 
  const distance = editDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
}

function editDistance(s1, s2){ 
  s1 = s1.toLowerCase(); 
  s2 = s2.toLowerCase(); 
  
  const costs = []; 
  for(let i = 0; i <= s1.length; i++){ 
    let lastValue = i; 
    for(let j = 0; j <= s2.length; j++){ 
      if(i === 0) {
        costs[j] = j; 
      } else { 
        if(j > 0){ 
          let newValue = costs[j - 1]; 
          if(s1.charAt(i - 1) !== s2.charAt(j - 1)) {
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; 
          }
          costs[j - 1] = lastValue; 
          lastValue = newValue; 
        } 
      } 
    } 
    if(i > 0) costs[s2.length] = lastValue; 
  } 
  return costs[s2.length]; 
}

// RESTART
document.getElementById("restartBtn").addEventListener("click", ()=>{
  console.log("ğŸ”„ Restart clicked");
  
  // Reset all state
  similarityScore = 0;
  audioChunks = [];
  spokenText = "";
  recognitionStarted = false;
  
  // Reset UI
  document.getElementById("scoreContainer").style.display = "none";
  document.getElementById("setupContainer").style.display = "block";
  document.getElementById("nameInput").value = "";
  departmentSelect.value = "";
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  feedback.textContent = "";
  feedback.className = "feedback";
  audioControls.innerHTML = "";
  viewScoreBtn.style.display = "none";
  setupError.textContent = "";
  
  // Re-enable buttons
  document.getElementById("startRec").disabled = false;
  document.getElementById("stopRec").disabled = true;
});
</script>

</body>
</html>
