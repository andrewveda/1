<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Voice Quest ğŸŒŒ</title>
<style>
body { margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: radial-gradient(circle at top left,#0f0c29,#302b63,#24243e); color:#e0e0e0; text-align:center; min-height:100vh; }
.container { max-width:800px; margin:2rem auto; background: rgba(30,30,50,0.8); padding:2rem; border-radius:15px; box-shadow:0 0 40px rgba(72,61,139,0.5);}
input, select { width:80%; padding:0.8rem; margin:0.5rem 0 1rem 0; border-radius:8px; border:1px solid #6c5fc7; background:rgba(255,255,255,0.1); color:#e0e0e0; font-size:1rem; }
label { display:block; margin-top:1rem; font-weight:bold; }
button { padding:1rem 2rem; margin:0.5rem; border:none; border-radius:10px; font-size:1rem; cursor:pointer; background-color:#4a3f9f; color:#fff; transition: background-color 0.3s ease, box-shadow 0.3s ease;}
button:hover:not(:disabled) { background-color:#6c5fc7; box-shadow:0 0 15px rgba(108,95,199,0.6);}
button:disabled { opacity:0.5; cursor:not-allowed; }
.correct { background-color: #00ff9f !important; color:#000; }
.wrong { background-color: #ff4f6e !important; color:#fff; }
#sentenceBox { margin:2rem 0; font-weight:bold; font-size:1.2rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:8px; line-height:1.6; }
.feedback { margin-top:1rem; font-size:1.1rem; padding:1rem; border-radius:8px; }
audio { margin-top:1rem; width:100%; max-width:500px; }
#audioControls { margin-top:1rem; }
#audioControls a { display:inline-block; padding:0.8rem 1.5rem; background:#00ffff; color:#000; text-decoration:none; border-radius:8px; margin-top:1rem; font-weight:bold; }
#audioControls a:hover { background:#00cccc; }
#scoreCard { font-size:1.2rem; line-height:2; }
#scoreCard p { margin:0.5rem 0; }
.error-message { color:#ff4f6e; margin-top:0.5rem; }
</style>
</head>
<body>

<div class="container" id="setupContainer">
  <h2>ğŸŒŒ Voice Quest</h2>
  <p>Select your details and start the speaking challenge!</p>
  
  <label>Name:</label>
  <input type="text" id="nameInput" placeholder="Enter your name"/>

  <label>Department:</label>
  <select id="departmentSelect">
    <option value="">-- Select Department --</option>
    <option value="Cyber Security">Cyber Security</option>
    <option value="Mechanical">Mechanical</option>
  </select>

  <label>Register Number:</label>
  <select id="regNoSelect">
    <option value="">-- Select Register Number --</option>
  </select>

  <div class="error-message" id="setupError"></div>
  <button onclick="beginQuest()">Start Quest</button>
</div>

<div class="container" id="questContainer" style="display:none;">
  <h2>ğŸ“– Read the Sentence Aloud</h2>
  <div id="sentenceBox"></div>
  <p style="font-size:0.9rem; color:#aaa;">Click "Start Speaking" and read the sentence clearly</p>
  <button id="startRec">ğŸ¤ Start Speaking</button>
  <button id="stopRec" disabled>â¹ Stop</button>
  <div class="feedback" id="feedback"></div>
  <div id="audioControls"></div>
  <div id="nextBtnContainer"></div>
</div>

<div class="container" id="scoreContainer" style="display:none;">
  <h2>ğŸ‰ Quest Completed!</h2>
  <div id="scoreCard"></div>
  <button id="restartBtn">ğŸ”„ Restart Quest</button>
</div>

<script>
// HARD-CODED DATA
const data = [
  {department:"Cyber Security", regNo:"CS101", sentence:"Grit gathers glory, grows greatness and makes grand the game of life"},
  {department:"Cyber Security", regNo:"CS102", sentence:"Be yourself everyone else is already taken"},
  {department:"Mechanical", regNo:"ME101", sentence:"Engineering minds build bridges and shape the world"},
  {department:"Mechanical", regNo:"ME102", sentence:"Innovation comes from persistence and curiosity"}
];

const departmentSelect = document.getElementById("departmentSelect");
const regNoSelect = document.getElementById("regNoSelect");
const sentenceBox = document.getElementById("sentenceBox");
const feedback = document.getElementById("feedback");
const audioControls = document.getElementById("audioControls");
const setupError = document.getElementById("setupError");

let playerName="", playerDepartment="", playerRegNo="", currentSentence="";
let similarityScore=0;
let mediaRecorder;
let audioChunks = [];
let recognition;
let audioStream;

// Check browser support
if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
  alert('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.');
}

// Populate register numbers based on department
departmentSelect.addEventListener('change', ()=>{
  const dept = departmentSelect.value;
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  if(dept) {
    data.filter(d=>d.department===dept).forEach(d=>{
      const option = document.createElement('option');
      option.value = d.regNo;
      option.textContent = d.regNo;
      regNoSelect.appendChild(option);
    });
  }
  setupError.textContent = "";
});

function beginQuest(){
  playerName = document.getElementById("nameInput").value.trim();
  playerDepartment = departmentSelect.value;
  playerRegNo = regNoSelect.value;
  
  if(!playerName || !playerDepartment || !playerRegNo){
    setupError.textContent = "âš ï¸ Please fill all fields!";
    return;
  }
  
  const entry = data.find(d=>d.department===playerDepartment && d.regNo===playerRegNo);
  if(!entry) {
    setupError.textContent = "âš ï¸ Invalid selection!";
    return;
  }
  
  currentSentence = entry.sentence;
  sentenceBox.textContent = currentSentence;
  
  document.getElementById("setupContainer").style.display = "none";
  document.getElementById("questContainer").style.display = "block";
  
  // Reset feedback and controls
  feedback.textContent = "";
  feedback.className = "feedback";
  audioControls.innerHTML = "";
  document.getElementById("nextBtnContainer").innerHTML = "";
}

// Initialize speech recognition
function initRecognition() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event)=>{
    const spoken = event.results[0][0].transcript.trim();
    console.log("Spoken:", spoken);
    console.log("Expected:", currentSentence);
    
    similarityScore = compareText(spoken, currentSentence);
    
    if(similarityScore >= 0.7){
      feedback.textContent = `âœ… Great job! Accuracy: ${Math.round(similarityScore*100)}%`;
      feedback.className = "feedback correct";
    } else {
      feedback.textContent = `âŒ Try again! Accuracy: ${Math.round(similarityScore*100)}%`;
      feedback.className = "feedback wrong";
    }
    
    feedback.textContent += "\n\nYou said: \"" + spoken + "\"";
    
    // SHOW NEXT BUTTON
    const nextBtnContainer = document.getElementById("nextBtnContainer");
    nextBtnContainer.innerHTML = "";
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "â¡ï¸ View Score";
    nextBtn.style.marginTop = "1rem";
    nextBtn.onclick = showScore;
    nextBtnContainer.appendChild(nextBtn);
  };
  
  recognition.onerror = (event)=>{
    console.error("Recognition error:", event.error);
    let errorMsg = "âš ï¸ Error: ";
    switch(event.error) {
      case 'no-speech':
        errorMsg += "No speech detected. Please try again.";
        break;
      case 'audio-capture':
        errorMsg += "No microphone found. Please check your device.";
        break;
      case 'not-allowed':
        errorMsg += "Microphone permission denied. Please allow access.";
        break;
      default:
        errorMsg += event.error;
    }
    feedback.textContent = errorMsg;
    feedback.className = "feedback";
    
    // Re-enable buttons
    document.getElementById("startRec").disabled = false;
    document.getElementById("stopRec").disabled = true;
    
    // Stop media recorder if active
    if(mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
    }
    if(audioStream) {
      audioStream.getTracks().forEach(track => track.stop());
    }
  };
  
  recognition.onend = ()=>{
    console.log("Recognition ended");
  };
}

// START RECORDING
document.getElementById("startRec").addEventListener("click", async ()=>{
  try {
    // Reset
    audioChunks = [];
    audioControls.innerHTML = "";
    feedback.textContent = "ğŸ™ï¸ Listening... Speak now!";
    feedback.className = "feedback";
    document.getElementById("nextBtnContainer").innerHTML = "";
    
    // Request microphone access
    audioStream = await navigator.mediaDevices.getUserMedia({audio: true});
    
    // Start recording
    mediaRecorder = new MediaRecorder(audioStream);
    mediaRecorder.ondataavailable = e => { 
      if(e.data.size > 0) {
        audioChunks.push(e.data); 
      }
    };
    mediaRecorder.onstop = ()=> { 
      createPlaybackAndDownload();
      // Stop all audio tracks
      if(audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
      }
    };
    
    mediaRecorder.start();
    
    // Start speech recognition
    initRecognition();
    recognition.start();
    
    // Update button states
    document.getElementById("startRec").disabled = true;
    document.getElementById("stopRec").disabled = false;
    
  } catch(error) {
    console.error("Error starting recording:", error);
    feedback.textContent = "âš ï¸ Could not access microphone. Please grant permission.";
    feedback.className = "feedback";
  }
});

// STOP RECORDING
document.getElementById("stopRec").addEventListener("click", ()=>{
  if(recognition) {
    recognition.stop();
  }
  if(mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
  }
  
  document.getElementById("startRec").disabled = false;
  document.getElementById("stopRec").disabled = true;
});

// CREATE PLAYBACK AND DOWNLOAD
function createPlaybackAndDownload(){
  if(audioChunks.length === 0) {
    console.warn("No audio chunks recorded");
    return;
  }
  
  const blob = new Blob(audioChunks, {type:'audio/webm'});
  const url = URL.createObjectURL(blob);
  
  const audioEl = document.createElement('audio');
  audioEl.controls = true;
  audioEl.src = url;
  
  const downloadBtn = document.createElement('a');
  downloadBtn.href = url;
  downloadBtn.download = `${playerName}_${playerRegNo}_recording.webm`;
  downloadBtn.textContent = "â¬‡ï¸ Download Recording";
  
  audioControls.innerHTML = "";
  audioControls.appendChild(audioEl);
  audioControls.appendChild(downloadBtn);
}

// SHOW SCORE
function showScore() {
  const accuracyPercent = Math.round(similarityScore * 100);
  let grade = "";
  if(accuracyPercent >= 90) grade = "ğŸ† Excellent!";
  else if(accuracyPercent >= 70) grade = "ğŸ‘ Good Job!";
  else grade = "ğŸ’ª Keep Practicing!";
  
  document.getElementById("scoreCard").innerHTML = `
    <p>ğŸ‘¤ <strong>Player:</strong> ${playerName}</p>
    <p>ğŸ“Š <strong>Accuracy:</strong> ${accuracyPercent}%</p>
    <p>ğŸ¯ <strong>Grade:</strong> ${grade}</p>
    <p>ğŸ· <strong>Department:</strong> ${playerDepartment}</p>
    <p>ğŸ”¢ <strong>Register No:</strong> ${playerRegNo}</p>
  `;
  
  document.getElementById("questContainer").style.display = "none";
  document.getElementById("scoreContainer").style.display = "block";
}

// TEXT COMPARISON FUNCTIONS
function compareText(a, b){ 
  const longer = a.length > b.length ? a : b; 
  const shorter = a.length > b.length ? b : a; 
  if(longer.length === 0) return 1.0; 
  const distance = editDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
}

function editDistance(s1, s2){ 
  s1 = s1.toLowerCase(); 
  s2 = s2.toLowerCase(); 
  
  const costs = []; 
  for(let i = 0; i <= s1.length; i++){ 
    let lastValue = i; 
    for(let j = 0; j <= s2.length; j++){ 
      if(i === 0) {
        costs[j] = j; 
      } else { 
        if(j > 0){ 
          let newValue = costs[j - 1]; 
          if(s1.charAt(i - 1) !== s2.charAt(j - 1)) {
            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; 
          }
          costs[j - 1] = lastValue; 
          lastValue = newValue; 
        } 
      } 
    } 
    if(i > 0) costs[s2.length] = lastValue; 
  } 
  return costs[s2.length]; 
}

// RESTART
document.getElementById("restartBtn").addEventListener("click", ()=>{
  // Reset all state
  similarityScore = 0;
  audioChunks = [];
  
  // Reset UI
  document.getElementById("scoreContainer").style.display = "none";
  document.getElementById("setupContainer").style.display = "block";
  document.getElementById("nameInput").value = "";
  departmentSelect.value = "";
  regNoSelect.innerHTML = '<option value="">-- Select Register Number --</option>';
  feedback.textContent = "";
  feedback.className = "feedback";
  audioControls.innerHTML = "";
  document.getElementById("nextBtnContainer").innerHTML = "";
  setupError.textContent = "";
  
  // Re-enable buttons
  document.getElementById("startRec").disabled = false;
  document.getElementById("stopRec").disabled = true;
});
</script>

</body>
</html>
